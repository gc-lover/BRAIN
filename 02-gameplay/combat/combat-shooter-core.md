# Combat Shooter Core — Боевая петля 3D-шутера

**Статус:** draft  
**Версия:** 0.1.0  
**Дата создания:** 2025-11-09  
**Последнее обновление:** 2025-11-09 15:15  
**Приоритет:** критический

**api-readiness:** in-progress  
**api-readiness-check-date:** 2025-11-09 15:15  
**api-readiness-notes:** Документ в работе — заменяет D&D ядро. Требуется заполнить разделы по баллистике, TTK, recoil, suppression, хитбоксам, сетевой синхронизации, античиту.

**target-domain:** gameplay-combat  
**target-microservice:** gameplay-service (8083)  
**target-frontend-module:** modules/combat/mechanics  

---

## 1. Цель
Перевести боевую систему NECPGAME на полноценный 3D-шутер: первый этап — веб-клиент (WebGL/WebGPU), далее перенос в UE5. Документ определяет боевую петлю, необходимые API и события, чтобы заменить D&D-проверки.

## 2. Основные компоненты
- **Классы оружия:** пистолеты, SMG, штурмовые, снайперские, дробовики, тяжелое оружие, энергетическое.
- **Баллистика:** hitscan и projectile, скорость пули, падение, проникающая способность, ricochet.
- **Модель урона:** hitboxes (head, torso, limbs), armor penetration, stagger, suppression.
- **Recoil & Spread:** вертикальная/горизонтальная отдача, bloom, стабилизация имплантами и перками.
- **TTK профили:** базовые time-to-kill по классам брони и уровням имплантов.
- **Movement modifiers:** влияние паркура, стелса, имплантов на точность, разброс и гашение отдачи.
- **Abilities & implants:** модификация оружия (переключение режимов, особые боеприпасы, усиление/ослабление).
- **Networking:** authoritative server, client-side prediction, reconciliation, shot validation, anticheat hooks.
- **Telemetry:** события `combat.shooter.fire`, `combat.shooter.hit`, `combat.shooter.kill`, `combat.shooter.suppress`, `combat.shooter.reload`.

## 3. API черновик
| Endpoint | Назначение | Приоритет |
| --- | --- | --- |
| `POST /combat/shooter/fire` | Отправка выстрела (оружие, позиция, направление, latency) | P0 |
| `POST /combat/shooter/hit` | Подтверждение попадания, урон, хитбокс | P0 |
| `POST /combat/shooter/reload` | Запуск/отмена перезарядки | P0 |
| `POST /combat/shooter/recoil` | Обновление отдачи/рассеивания (для UI) | P1 |
| `POST /combat/shooter/suppress` | Событие подавления, влияние на команду | P1 |
| `GET /combat/shooter/weapon-stats` | Каталог параметров оружия и апгрейдов | P1 |
| `POST /combat/shooter/ability-modifiers` | Применение способностей/имплантов к оружию | P1 |
| `POST /combat/shooter/projectile` | Отслеживание медленных снарядов (ракеты, гранаты) | P1 |
| `GET /combat/shooter/telemetry` | Агрегированные метрики (accuracy, TTK) | P2 |

## 4. Следующие шаги
1. Заполнить детальные параметры по оружию, баллистике и хитбоксам (совместно с combat-shooting.md).
2. Определить payload для WebSocket и Kafka потоков (raid, session, suppression).
3. Согласовать с quest-engine и analytics переход на новые события (без D&D).
4. Подготовить схему античита и клиент-серверной валидации (shot validation, prediction).

## 5. История изменений
- 2025-11-09 15:15 — создан черновик как замена D&D ядру.
---
**api-readiness:** drafting  
**api-readiness-check-date:** 2025-11-09 23:30  
**api-readiness-notes:** Новый документ, заменяющий устаревшие D&D материалы. Требуется заполнить метрики TTK, баллистики, сетевой авторитетности и античита для wave 1 combat.

**target-domain:** gameplay-combat  
**target-microservice:** gameplay-service (8083)  
**target-frontend-module:** modules/combat/shooter
---

# Combat Shooter Core — Реалтайм боевая петля

**Статус:** draft  
**Версия:** 0.1.0  
**Дата создания:** 2025-11-09  
**Ответственный:** Brain Manager  
**Приоритет:** critical

Документ описывает фундаментальные механики 3D-шутера NECPGAME для веб-версии и дальнейшего переноса в UE5. Заменяет dice-based материалы (`combat-dnd-*`). Ориентиры: Valorant (чистота стрельбы), Tarkov (экстрактшутер риски), Cyberpunk 2077 (импланты), ARC Raiders (кооперативные рейды).

---

## 1. Основные цели
- Определить модели оружия, баллистики и Time-to-Kill (TTK) для PvE и PvP.
- Зафиксировать правила хитскана и projectile баллистики, включая падение пули, пробитие и рикошеты.
- Описать систему контроля отдачи, рассеивания, перегрева и обслуживания оружия.
- Сформулировать требования к сетевой синхронизации: authoritative сервер, предикция клиента, reconciliation.
- Указать античит ограничения (скорость кликов, макросы, сетевые подписи).
- Прописать зависимость от имплантов, способностей, лоадаутов и прогрессии без кубиков и D&D бросков.

---

## 2. Категории оружия
| Класс | Примеры | Механика | Диапазон TTK | Особенности |
| --- | --- | --- | --- | --- |
| Пистолеты | Лазерные, кинетические | Hitscan, низкая отдача | 550–700 мс | Бонус к мобильности, быстрые смены |
| ПП/SMG | Электромагнитные, плазменные | Hitscan + легкий спад | 450–600 мс | Высокий DPS вблизи, штраф на дистанции |
| Штурмовые винтовки | Баллистические, гибридные | Projectile + контролируемый пад | 500–650 мс | Универсальный класс, моды под роли |
| Тяжелое оружие | Миниганы, рейлган | Projectile + разогрев | 400–520 мс | Перегрев, серво-импланты обязательны |
| Снайперские | Рельсовые, оптические | Hitscan/Projectile | 250–400 мс | Пробитие брони, требование устойчивости |
| Экзотические | Наномеханика | Особые эффекты | 600–800 мс | Допэффекты (dot, stun), высокий расход энергии |

TTK учитывает базовое попадание в тело без критов. Критические зоны снижают TTK на 20–40% в зависимости от имплантов и роли.

---

## 3. Баллистика и попадания
- **Hitscan:** используется для пистолетов, SMG, части винтовок. Сервер проверяет линию, учитывает укрытия, фазу кадра и лаг компенсацию.
- **Projectile:** скорость пули, гравитационный спад, пробитие материалов. Синхронизация через server-authoritative state + client prediction.
- **Пробитие и рикошет:** таблицы материалов (`light_cover`, `medium_cover`, `heavy_cover`) с параметрами пробития и отклонения угла.
- **Импланты влияния:** `optic_suite`, `neural_reflex`, `gyro_stabilizer` — снижают разброс, ускоряют reacquire, повышают точность.
- **Anti-cheat:** `X-AntiCheat-Signature`, rate limits на fire events, server-side validation (cone check, recoil pattern, time since last shot).

---

## 4. Контроль отдачи и разброс
- **Паттерны отдачи:** определяются профилем оружия (линейный, Z-пила, спираль). Отображаются в клиенте для обучения.
- **Ресурсы контроля:** импланты (`stability implants`), перки (`recoil discipline`), лоадаут (приклады, компенсаторы).
- **Механика перегрева:** энергетическое оружие и импланты нагреваются, требуя системы охлаждения. При перегреве — штраф к точности или отключение.
- **Рассеивание:** базовый конус + случайный фактор <2°. Активация способностей может временно уменьшать или увеличивать конус.

---

## 5. Сетевой уровень
- **Server-authoritative:** сервер фиксирует попадания, рассчитывает урон и раздаёт события. Клиент отправляет `fire`, `hit`, `reload`.
- **Client prediction:** локальное отображение попаданий с последующим reconciliation (сервер подтверждает/отклоняет).
- **Lag compensation:** хранение history позиций (`rewind buffer` до 250 мс). Выстрелы проверяются по истории цели.
- **Telemetry:** `combat.shooter.fire`, `combat.shooter.hit`, `combat.shooter.miss`, `combat.shooter.reload`, `combat.shooter.overheat`.

---

## 6. Влияние ролей и имплантов
- **Tank:** повышенный `resilience`, доступ к тяжелому оружию, импланты поглощения урона.
- **DPS:** бонус к `accuracy`, `handling`, доступ к rapid-fire модам.
- **Support:** усилители боевых имплантов, перезарядка союзников, модули стабилизации.
- **Hybrid:** гибкие лоадауты, баланс между точностью и утилити.
- Импланты подключаются через `combat-implants-types`, расходуют энергию и влияют на `energy_budget`.

---

## 7. Прогрессия и лоадауты
- **Лоадауты:** `primary`, `secondary`, `heavy`, `gadget`, `implant`, `ability`. Управляются документом `combat-loadouts-system.md`.
- **Разблокировки:** уровни персонажа, клановые исследования, экономические контракты.
- **Моды:** прицелы, компенсаторы, barrel моды, ammo типы (AP, shock, EMP, incendiary).
- **Недоступность кубиков:** исход битвы определяется точностью, позиционированием и имплантами, а не случайными бросками.

---

## 8. Метрики и телеметрия
- `shooter_ttk_average`, `shooter_accuracy_rate`, `shooter_headshot_rate`, `shooter_overheat_events`, `shooter_macro_flagged`.
- `/api/v1/telemetry/combat/shooter` — агрегирование показателей; интеграция с analytics-service и anti-cheat.

---

## 9. Интеграции
- **combat-session-backend:** старт/завершение сессий, события damage/hit, синхронизация с raid AI.
- **combat-abilities.md:** навыки, которые модифицируют отдачу, конус, перегрев.
- **combat-stealth.md:** шум, вспышки и сигнатуры влияют на детекцию.
- **combat-hacking-combat-integration.md:** remote overrides, временные бафы/дебафы оружия.
- **quest-engine-backend.md:** использует shooter events (`skill-test`) вместо D&D бросков.

---

## 10. Следующие шаги
1. Дополнить таблицы оружия конкретными моделями и параметрами (урон, скорострельность, падения).
2. Согласовать с analytics-service набор событий и агрегатов.
3. Подготовить требования к QA (latency tests, anti-cheat сценарии).
4. Обновить связанные документы, исключив ссылки на D&D механики.

---

## История изменений
- v0.1.0 (2025-11-09) — создан базовый каркас, перенёс фокус с D&D на реалтайм шутер.

