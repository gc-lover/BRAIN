---
**api-readiness:** needs-work  
**api-readiness-check-date:** 2025-11-07 16:36  
**api-readiness-notes:** Базовый алгоритм наполнения городов. Требуется формализация API контрактов и схем БД перед передачей в API-SWAGGER.
---

# Алгоритм наполнения городов NPC и инфраструктурой

**Статус:** В разработке — первый драфт  
**Версия:** 0.1.0  
**Дата:** 2025-11-07 16:36  
**Приоритет:** Высокий  
**Автор:** AI Brain Manager

**Микросервисы:** world-service (8086), social-service (8084), economy-service (8085), gameplay-service (8083)  
**Фронтенд модули:** world (production), social (production), economy (production), gameplay (MVP)

---

## Цель и ключевые эффекты

- Создать живые города с динамичной плотностью NPC, инфраструктурой и активностями, которые реагируют на действия игрока и глобальные события.
- Обеспечить согласованность между лором (`03-lore/locations`), механиками (`02-gameplay/world`) и технической реализацией (`05-technical`).
- Подготовить данные и процессы для последующей автоматизации API задач и наполнения БД без жёстко захардкоженных сущностей.

---

## Входные данные и каталоги

- `world_city_blueprints` — стационарные контуры районов, доступные площади, транспортные узлы (источник: world-service).
- `npc_archetype_library` — архетипы NPC, роли, поведенческие шаблоны, требования к инфраструктуре (источник: social-service + content pipeline).
- `infrastructure_catalog` — типы объектов (жильё, сервисы, развлечения, безопасность, нелегальная инфраструктура) с емкостями и потребностями в персонале (источник: economy-service).
- `event_schedule` — список глобальных и локальных событий, влияющих на трафик и потребности (источник: world-service events).
- `player_impact_stream` — данные о владениях фракций, прогрессе квестов, экономических трендах игроков (источник: gameplay-service + economy-service telemetry).

---

## Поток наполнения города

1. **Сегментация районов:** кластеризация кварталов по функциям (жилая, деловая, промышленная, культурная, криминальная, смешанная). На вход идут blueprint и исторические данные.
2. **Расчёт спроса:** для каждого сегмента рассчитывается спрос на инфраструктуру и NPC на основе целевых метрик плотности, активных событий, времени суток и влияния фракций.
3. **Генерация инфраструктуры:** подбор объектов из каталога с учётом лимитов площади, энергопотребления и синергий (например, бар рядом с транспортным узлом, черный рынок в криминальных кварталах).
4. **Формирование NPC-склада:** сбор пула NPC по архетипам, учитывая локальные культурные особенности, текущие истории и требования объектов (работники, посетители, криминальные группировки, органы правопорядка, уличные артисты, бытовые жители).
5. **Назначение расписаний:** создание дневных и ночных циклов, распределение NPC по маршрутам (дом → работа → отдых, патрули, события, скрытые активности). Учитывается транспорт, погодные условия, уровень угрозы.
6. **Интеграция событий:** наложение глобальных и локальных событий, которые временно меняют трафик, открывают временные локации, добавляют уникальных NPC.
7. **Синхронизация с миром:** публикация итоговой конфигурации в `world_state` (world-service), `social_graph` (social-service) и `economy_supply` (economy-service). Gameplay-service подписывается на изменения для задач, квестов и боевых сценариев.
8. **Реакция на игрока:** при значимых действиях (захват района, устранение лидера, рост криминала) триггерится пересчёт шагов 2-7 для затронутых сегментов в асинхронном режиме.

---

## Модули алгоритма

### 1. Сегментация и профили районов
- Метрики: плотность населения, уровень дохода, преступность, технологичность, влияние фракций.
- Инструмент: кластеризация (k-prototypes) с весами, заданными world-service.
- Выход: `district_profile` с набором тегов и параметров для последующих шагов.

### 2. Планировщик инфраструктуры
- Подбирает обязательные и вариативные объекты по типу района.
- Учитывает зависимости (например, госпиталь требует аптеки, транспортного узла и жилого фонда сотрудников).
- Оптимизирует по трём критериям: удовлетворённый спрос жителей, возможности экономики (налоговые доходы, энергопотребление), баланс безопасности/криминала.

### 3. Генератор NPC пула
- Использует архетипы: жители, работники сервисов, криминальные акторы, оперативники корпораций, уличные артисты, уникальные сюжетные NPC.
- Применяет культурные фильтры из лора, сетевые связи (friends, rivals, faction allegiance).
- Учитывает квоты по редкости (уникальные NPC < 1%, элита 5%, массовые 70%).

### 4. Планировщик расписаний
- Формирует для каждого NPC цепочки состояний: местоположение, активность, группе同行 (патрули, семьи, банды).
- Строит граф перемещений с использованием транспортных сетей и настроек трафика.
- Генерирует три режима: стандартный день, режим событий, режим чрезвычайной ситуации.

### 5. Динамический адаптер
- Слушает события world-service (погода, атаки, праздники), social-service (отношения фракций, протесты), economy-service (спрос на товары).
- Триггерит частичный пересчёт инфраструктуры и NPC, избегая полного регенера.
- Обновляет world_state через версионированные патчи, чтобы фронтенд мог анимировать изменения.

### 6. Контур качества и тестирования
- Метрические проверки: плотность NPC, баланс ролей, маршруты без тупиков, уровень загрузки инфраструктуры.
- Симуляция пиковых часов для выявления узких мест (AI load test).
- QA сценарии: реакции на квесты, преступления, события, массовые рейды игроков.

---

## Интеграция по микросервисам

- **world-service (8086):** хранение blueprint городов, событий, публикация финальной конфигурации инфраструктуры, управление версиями мирового состояния.
- **social-service (8084):** управление NPC, их связями, расписаниями, отношениями, синхронизация с романтической и социальной системами.
- **economy-service (8085):** контроль ресурсов инфраструктуры, генерация спроса/предложения, обновление торговых точек и нелегальных рынков.
- **gameplay-service (8083):** получение данных о активности игроков, квестах, боевых столкновениях, триггер пересчёта и выдача контента игрокам.

Фронтенд модуль world визуализирует живость города, social отображает взаимодействия NPC, economy отвечает за торговые точки и динамические цены, gameplay обеспечивает задачи и эвенты, связанные с городской жизнью.

---

## Схема данных (предварительная)

- `city_districts` (world-service): идентификатор района, теги, коэффициенты спроса, текущая версия.
- `infrastructure_instances` (economy-service): тип объекта, владелец, вместимость, активные услуги, связанный район.
- `npc_profiles` (social-service): архетип, расписания, связи, уровень приоритета, привязанный объект инфраструктуры.
- `npc_schedules` (social-service): временные слоты, маршрут, контекст события.
- `world_events_bindings` (world-service): событие → районы → модификаторы спроса и NPC.
- `player_impact_log` (gameplay-service): действия игрока, масштаб влияния, инициатор пересчёта.

Все таблицы версионируются и синхронизируются через событийную шину (Kafka/Redpanda) с использованием компактных payload и idempotent update.

---

## Метрики живости города

- Средняя плотность NPC по районам и времени суток, отклонение не более ±15% от целевого диапазона.
- Коэффициент использования инфраструктуры (целевой 60–85%).
- Индекс разнообразия ролей (Shannon Index > 1.8 для крупных районов).
- Доля динамических NPC (минимум 25% получают события или реагируют на игрока в течение игрового дня).
- Среднее время реакции на события игрока (< 3 игровых минуты для локальных, < 15 для глобальных).

---

## Дальнейшая проработка

1. Формализовать схемы БД и событийную модель для каждого сервиса и подготовить требования к API (передача в API-SWAGGER).
2. Согласовать с лор-отделом карту культурных ограничений и привязок NPC к регионам.
3. Настроить контур тестовых симуляций (минимум 24 игровых часа) для проверки устойчивости алгоритма.
4. Определить приоритеты городов для первой волны генерации и подготовить baseline данные.
5. Интегрировать метрики живости в мониторинг и дашборды для live-ops команды.

---

## Связанные документы

- `.BRAIN/03-lore/locations/` — лор и детализированные описания городов и районов.
- `.BRAIN/02-gameplay/world/world-state/` — глобальные механики влияния игрока.
- `.BRAIN/05-technical/content-generation/npc-profile-generator/` — генератор архетипов и профилей NPC.
- `.BRAIN/05-technical/global-state/` — механики синхронизации мира.

