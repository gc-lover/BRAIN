---
**api-readiness:** ready  
**api-readiness-check-date:** 2025-11-07 05:20  
**api-readiness-notes:** ╨Я╨╛╨╗╨╜╨░╤П ╤Б╨╕╤Б╤В╨╡╨╝╨░ ╨╕╨╜╨▓╨╡╨╜╤В╨░╤А╤П. Slots, stacking, weight/encumbrance, pickup/drop, use/consume, equipment slots, bank/stash, transfer items (trade, mail, auction).
---

# Inventory System - ╨б╨╕╤Б╤В╨╡╨╝╨░ ╨╕╨╜╨▓╨╡╨╜╤В╨░╤А╤П

**╨б╤В╨░╤В╤Г╤Б:** approved  
**╨Т╨╡╤А╤Б╨╕╤П:** 1.0.0  
**╨Ф╨░╤В╨░ ╤Б╨╛╨╖╨┤╨░╨╜╨╕╤П:** 2025-11-07  
**╨Я╨╛╤Б╨╗╨╡╨┤╨╜╨╡╨╡ ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡:** 2025-11-07 05:20  
**╨Я╤А╨╕╨╛╤А╨╕╤В╨╡╤В:** ╨Ъ╨а╨Ш╨в╨Ш╨з╨Х╨б╨Ъ╨Ш╨Щ (MVP ╨▒╨╗╨╛╨║╨╡╤А!)  
**╨Р╨▓╤В╨╛╤А:** AI Brain Manager

**╨б╤В╨░╤В╤Г╤Б:** approved  
**╨Т╨╡╤А╤Б╨╕╤П:** 1.0.0  
**╨Ф╨░╤В╨░ ╤Б╨╛╨╖╨┤╨░╨╜╨╕╤П:** 2025-11-07  
**╨Я╨╛╤Б╨╗╨╡╨┤╨╜╨╡╨╡ ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡:** 2025-11-07 05:20  
**╨Я╤А╨╕╨╛╤А╨╕╤В╨╡╤В:** ╨Ъ╨а╨Ш╨в╨Ш╨з╨Х╨б╨Ъ╨Ш╨Щ (MVP ╨▒╨╗╨╛╨║╨╡╤А!)  
**╨Р╨▓╤В╨╛╤А:** AI Brain Manager

---

## ╨Ъ╤А╨░╤В╨║╨╛╨╡ ╨╛╨┐╨╕╤Б╨░╨╜╨╕╨╡

**Inventory System** - ╨║╤А╨╕╤В╨╕╤З╨╡╤Б╨║╨╕ ╨▓╨░╨╢╨╜╨░╤П ╤Б╨╕╤Б╤В╨╡╨╝╨░ ╨┤╨╗╤П ╤Г╨┐╤А╨░╨▓╨╗╨╡╨╜╨╕╤П ╨┐╤А╨╡╨┤╨╝╨╡╤В╨░╨╝╨╕ ╨╕╨│╤А╨╛╨║╨╛╨▓. ╨С╨╡╨╖ ╤Н╤В╨╛╨╣ ╤Б╨╕╤Б╤В╨╡╨╝╤Л ╨╕╨│╤А╨░ ╨╜╨╡ ╨╝╨╛╨╢╨╡╤В ╤А╨░╨▒╨╛╤В╨░╤В╤М. ╨Ю╨▒╨╡╤Б╨┐╨╡╤З╨╕╨▓╨░╨╡╤В ╤Е╤А╨░╨╜╨╡╨╜╨╕╨╡, ╤Г╨┐╤А╨░╨▓╨╗╨╡╨╜╨╕╨╡, ╨┐╨╡╤А╨╡╨╝╨╡╤Й╨╡╨╜╨╕╨╡ ╨╕ ╨╕╤Б╨┐╨╛╨╗╤М╨╖╨╛╨▓╨░╨╜╨╕╨╡ ╨┐╤А╨╡╨┤╨╝╨╡╤В╨╛╨▓.

**╨Ъ╨╗╤О╤З╨╡╨▓╤Л╨╡ ╨▓╨╛╨╖╨╝╨╛╨╢╨╜╨╛╤Б╤В╨╕:**
- тЬЕ Inventory slots (╨╛╨│╤А╨░╨╜╨╕╤З╨╡╨╜╨╜╨╛╨╡ ╨║╨╛╨╗╨╕╤З╨╡╤Б╤В╨▓╨╛ ╤Б╨╗╨╛╤В╨╛╨▓)
- тЬЕ Item stacking (╤Б╨║╨╗╨░╨┤╤Л╨▓╨░╨╜╨╕╨╡ ╨╛╨┤╨╜╨╛╤В╨╕╨┐╨╜╤Л╤Е ╨┐╤А╨╡╨┤╨╝╨╡╤В╨╛╨▓)
- тЬЕ Weight/Encumbrance system (╨▓╨╡╤Б ╨╕ ╨┐╨╡╤А╨╡╨│╤А╤Г╨╖╨║╨░)
- тЬЕ Item pickup/drop
- тЬЕ Item use/consume
- тЬЕ Equipment slots (weapon, armor, implants, cyberware)
- тЬЕ Bank/Stash storage (╨┤╨╛╨┐╨╛╨╗╨╜╨╕╤В╨╡╨╗╤М╨╜╨╛╨╡ ╤Е╤А╨░╨╜╨╕╨╗╨╕╤Й╨╡)
- тЬЕ Transfer items (trade, mail, auction)
- тЬЕ Item durability (╨╕╨╖╨╜╨╛╤Б ╨┐╤А╨╡╨┤╨╝╨╡╤В╨╛╨▓)
- тЬЕ Bind-on-Pickup / Bind-on-Equip

---

## ╨Р╤А╤Е╨╕╤В╨╡╨║╤В╤Г╤А╨░ ╤Б╨╕╤Б╤В╨╡╨╝╤Л

### Inventory Structure

```
CHARACTER
    тФВ
    тФЬтФАтЖТ BACKPACK (Inventory)
    тФВ   тФЬтФА Slot 1: Weapon (stackable: no)
    тФВ   тФЬтФА Slot 2: Ammo x250 (stackable: yes)
    тФВ   тФЬтФА Slot 3: Medikit x5 (stackable: yes)
    тФВ   тФЬтФА ...
    тФВ   тФФтФА Slot 50: (empty)
    тФВ
    тФЬтФАтЖТ EQUIPMENT (Equipped items)
    тФВ   тФЬтФА Weapon Slot 1: Mantis Blades
    тФВ   тФЬтФА Weapon Slot 2: Pistol
    тФВ   тФЬтФА Armor: Corpo Suit
    тФВ   тФЬтФА Implants: [Kerenzikov, Sandevistan, ...]
    тФВ   тФФтФА Cyberware: [Optical Implant, Gorilla Arms, ...]
    тФВ
    тФФтФАтЖТ BANK/STASH (Shared storage)
        тФЬтФА Slot 1: Materials x999
        тФЬтФА Slot 2: Rare Item
        тФЬтФА ...
        тФФтФА Slot 100: (empty)
```

---

## Database Schema

### ╨в╨░╨▒╨╗╨╕╤Ж╨░ `character_inventory`

```sql
CREATE TABLE character_inventory (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL,
    
    -- ╨Ш╨╜╨▓╨╡╨╜╤В╨░╤А╤М
    max_slots INTEGER DEFAULT 50,
    current_weight DECIMAL(10,2) DEFAULT 0,
    max_weight DECIMAL(10,2) DEFAULT 200.00, -- ╨Ч╨░╨▓╨╕╤Б╨╕╤В ╨╛╤В Body attribute
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_inventory_character FOREIGN KEY (character_id) 
        REFERENCES characters(id) ON DELETE CASCADE,
    UNIQUE(character_id)
);
```

### ╨в╨░╨▒╨╗╨╕╤Ж╨░ `character_items`

```sql
CREATE TABLE character_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL,
    
    -- Item reference
    item_template_id VARCHAR(100) NOT NULL, -- ID ╤И╨░╨▒╨╗╨╛╨╜╨░ ╨┐╤А╨╡╨┤╨╝╨╡╤В╨░
    
    -- Location
    storage_type VARCHAR(20) NOT NULL DEFAULT 'BACKPACK',
    -- BACKPACK, EQUIPPED, BANK, STASH
    
    slot_index INTEGER, -- ╨Я╨╛╨╖╨╕╤Ж╨╕╤П ╨▓ ╨╕╨╜╨▓╨╡╨╜╤В╨░╤А╨╡ (0-49 for backpack, 0-99 for bank)
    equipment_slot VARCHAR(50), -- ╨Х╤Б╨╗╨╕ EQUIPPED: WEAPON_1, WEAPON_2, ARMOR, etc
    
    -- Quantity (╨┤╨╗╤П stackable items)
    quantity INTEGER DEFAULT 1,
    
    -- Durability (╨┤╨╗╤П equipment)
    current_durability INTEGER DEFAULT 100,
    max_durability INTEGER DEFAULT 100,
    
    -- Binding
    bind_type VARCHAR(20) DEFAULT 'NONE',
    -- NONE, BIND_ON_PICKUP, BIND_ON_EQUIP, BIND_TO_ACCOUNT
    
    is_bound BOOLEAN DEFAULT FALSE,
    bound_at TIMESTAMP,
    
    -- Modifiers (╨┤╨╗╤П ╤Г╨╜╨╕╨║╨░╨╗╤М╨╜╤Л╤Е ╨┐╤А╨╡╨┤╨╝╨╡╤В╨╛╨▓)
    modifiers JSONB, -- {damage_bonus: +10, crit_chance: +5%}
    
    -- Enchantments / Upgrades
    enchantments JSONB DEFAULT '[]',
    upgrade_level INTEGER DEFAULT 0,
    
    -- Acquisition
    acquired_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    acquired_from VARCHAR(100), -- LOOT, CRAFT, TRADE, QUEST, PURCHASE
    
    -- Trading
    is_tradeable BOOLEAN DEFAULT TRUE,
    is_sellable BOOLEAN DEFAULT TRUE,
    is_deletable BOOLEAN DEFAULT TRUE,
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_item_character FOREIGN KEY (character_id) 
        REFERENCES characters(id) ON DELETE CASCADE
);

CREATE INDEX idx_items_character ON character_items(character_id);
CREATE INDEX idx_items_template ON character_items(item_template_id);
CREATE INDEX idx_items_storage ON character_items(character_id, storage_type);
CREATE INDEX idx_items_slot ON character_items(character_id, storage_type, slot_index);
```

### ╨в╨░╨▒╨╗╨╕╤Ж╨░ `item_templates`

```sql
CREATE TABLE item_templates (
    id VARCHAR(100) PRIMARY KEY,
    
    -- Basic info
    item_name VARCHAR(200) NOT NULL,
    item_type VARCHAR(50) NOT NULL,
    -- WEAPON, ARMOR, CONSUMABLE, MATERIAL, QUEST_ITEM, CYBERWARE, IMPLANT, etc
    
    item_subtype VARCHAR(50), -- PISTOL, RIFLE, MELEE, etc
    
    -- Rarity
    rarity VARCHAR(20) DEFAULT 'COMMON',
    -- COMMON, UNCOMMON, RARE, EPIC, LEGENDARY, UNIQUE
    
    -- Stacking
    is_stackable BOOLEAN DEFAULT FALSE,
    max_stack_size INTEGER DEFAULT 1,
    
    -- Weight
    weight DECIMAL(6,2) DEFAULT 1.00,
    
    -- Value
    vendor_price INTEGER DEFAULT 0,
    
    -- Requirements
    required_level INTEGER DEFAULT 1,
    required_attributes JSONB, -- {body: 5, reflexes: 8}
    
    -- Stats (╨┤╨╗╤П equipment)
    stats JSONB, -- {damage: 50, armor: 100, etc}
    
    -- Effects (╨┤╨╗╤П consumables)
    effects JSONB, -- [{type: "HEAL", value: 50}]
    
    -- Icon
    icon_url VARCHAR(500),
    
    -- Description
    description TEXT,
    lore_text TEXT,
    
    -- Flags
    is_unique BOOLEAN DEFAULT FALSE,
    is_quest_item BOOLEAN DEFAULT FALSE,
    
    -- Binding
    bind_on_pickup BOOLEAN DEFAULT FALSE,
    bind_on_equip BOOLEAN DEFAULT FALSE,
    
    -- Trading
    is_tradeable BOOLEAN DEFAULT TRUE,
    is_sellable BOOLEAN DEFAULT TRUE,
    is_deletable BOOLEAN DEFAULT TRUE,
    
    -- Durability
    has_durability BOOLEAN DEFAULT FALSE,
    base_durability INTEGER DEFAULT 100,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_templates_type ON item_templates(item_type);
CREATE INDEX idx_templates_rarity ON item_templates(rarity);
```

### ╨в╨░╨▒╨╗╨╕╤Ж╨░ `equipment_slots`

```sql
CREATE TABLE equipment_slots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL,
    
    -- Weapon slots
    weapon_slot_1 UUID, -- FK to character_items
    weapon_slot_2 UUID,
    weapon_slot_3 UUID, -- Unlocks at level 10
    
    -- Armor
    head_slot UUID,
    chest_slot UUID,
    legs_slot UUID,
    boots_slot UUID,
    gloves_slot UUID,
    
    -- Cyberware/Implants (multiple slots)
    cyberware_slots JSONB DEFAULT '[]', -- Array of character_item IDs
    implant_slots JSONB DEFAULT '[]',
    
    -- Accessories
    accessory_slot_1 UUID,
    accessory_slot_2 UUID,
    
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_equipment_character FOREIGN KEY (character_id) 
        REFERENCES characters(id) ON DELETE CASCADE,
    UNIQUE(character_id)
);
```

### ╨в╨░╨▒╨╗╨╕╤Ж╨░ `bank_storage`

```sql
CREATE TABLE bank_storage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID NOT NULL, -- Shared between characters!
    
    max_slots INTEGER DEFAULT 100,
    
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_bank_account FOREIGN KEY (account_id) 
        REFERENCES accounts(id) ON DELETE CASCADE,
    UNIQUE(account_id)
);
```

---

## Item Pickup

### ╨Я╨╛╨┤╨▒╨╛╤А ╨┐╤А╨╡╨┤╨╝╨╡╤В╨░ ╤Б ╨╖╨╡╨╝╨╗╨╕

```java
@Service
public class InventoryService {
    
    @Transactional
    public PickupResponse pickupItem(
        UUID characterId,
        String itemTemplateId,
        int quantity
    ) {
        // 1. ╨Я╨╛╨╗╤Г╤З╨╕╤В╤М ╨╕╨╜╨▓╨╡╨╜╤В╨░╤А╤М
        CharacterInventory inventory = inventoryRepository
            .findByCharacter(characterId)
            .orElseThrow(() -> new InventoryNotFoundException());
        
        // 2. ╨Я╨╛╨╗╤Г╤З╨╕╤В╤М ╤И╨░╨▒╨╗╨╛╨╜ ╨┐╤А╨╡╨┤╨╝╨╡╤В╨░
        ItemTemplate template = itemTemplateRepository.findById(itemTemplateId)
            .orElseThrow(() -> new ItemTemplateNotFoundException());
        
        // 3. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М ╨▓╨╡╤Б
        double totalWeight = template.getWeight() * quantity;
        if (inventory.getCurrentWeight() + totalWeight > inventory.getMaxWeight()) {
            throw new OverweightException(
                "Cannot carry more weight. Drop some items or increase Body attribute."
            );
        }
        
        // 4. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М requirements
        if (!meetsRequirements(characterId, template)) {
            throw new RequirementsNotMetException(
                "You don't meet the requirements for this item"
            );
        }
        
        // 5. ╨Х╤Б╨╗╨╕ stackable, ╨┐╨╛╨┐╤А╨╛╨▒╨╛╨▓╨░╤В╤М ╨┤╨╛╨▒╨░╨▓╨╕╤В╤М ╨║ ╤Б╤Г╤Й╨╡╤Б╤В╨▓╤Г╤О╤Й╨╡╨╝╤Г ╤Б╤В╨╡╨║╤Г
        if (template.isStackable()) {
            Optional<CharacterItem> existingStack = findExistingStack(
                characterId,
                itemTemplateId
            );
            
            if (existingStack.isPresent()) {
                CharacterItem item = existingStack.get();
                
                int newQuantity = item.getQuantity() + quantity;
                if (newQuantity > template.getMaxStackSize()) {
                    // ╨б╤В╨╡╨║ ╨┐╨╡╤А╨╡╨┐╨╛╨╗╨╜╨╡╨╜, ╤Б╨╛╨╖╨┤╨░╨╡╨╝ ╨╜╨╛╨▓╤Л╨╣
                    int overflow = newQuantity - template.getMaxStackSize();
                    item.setQuantity(template.getMaxStackSize());
                    itemRepository.save(item);
                    
                    // ╨б╨╛╨╖╨┤╨░╤В╤М ╨╜╨╛╨▓╤Л╨╣ ╤Б╤В╨╡╨║ ╨┤╨╗╤П overflow
                    return pickupItem(characterId, itemTemplateId, overflow);
                } else {
                    item.setQuantity(newQuantity);
                    itemRepository.save(item);
                    
                    return new PickupResponse(item.getId(), "Added to existing stack");
                }
            }
        }
        
        // 6. ╨Э╨░╨╣╤В╨╕ ╤Б╨▓╨╛╨▒╨╛╨┤╨╜╤Л╨╣ ╤Б╨╗╨╛╤В
        int freeSlot = findFreeSlot(characterId, StorageType.BACKPACK);
        if (freeSlot == -1) {
            throw new InventoryFullException("No free inventory slots");
        }
        
        // 7. ╨б╨╛╨╖╨┤╨░╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В
        CharacterItem item = new CharacterItem();
        item.setCharacterId(characterId);
        item.setItemTemplateId(itemTemplateId);
        item.setStorageType(StorageType.BACKPACK);
        item.setSlotIndex(freeSlot);
        item.setQuantity(quantity);
        item.setAcquiredFrom("LOOT");
        
        // Bind-on-pickup
        if (template.isBindOnPickup()) {
            item.setBindType(BindType.BIND_ON_PICKUP);
            item.setBound(true);
            item.setBoundAt(Instant.now());
        }
        
        item = itemRepository.save(item);
        
        // 8. ╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М ╨▓╨╡╤Б
        inventory.setCurrentWeight(inventory.getCurrentWeight() + totalWeight);
        inventoryRepository.save(inventory);
        
        // 9. ╨Ы╨╛╨│╨╕╤А╨╛╨▓╨░╤В╤М
        log.info("Character {} picked up {} x{}", characterId, itemTemplateId, quantity);
        
        // 10. ╨г╨▓╨╡╨┤╨╛╨╝╨╕╤В╤М
        notificationService.send(
            getAccountId(characterId),
            new ItemPickedUpNotification(template.getItemName(), quantity)
        );
        
        return new PickupResponse(item.getId(), "Item picked up");
    }
    
    private boolean meetsRequirements(UUID characterId, ItemTemplate template) {
        if (template.getRequiredAttributes() == null) {
            return true;
        }
        
        Character character = characterRepository.findById(characterId).get();
        Map<String, Integer> attributes = character.getAttributes();
        Map<String, Integer> required = template.getRequiredAttributes();
        
        for (Map.Entry<String, Integer> entry : required.entrySet()) {
            int playerValue = attributes.getOrDefault(entry.getKey(), 0);
            if (playerValue < entry.getValue()) {
                return false;
            }
        }
        
        return true;
    }
}
```

---

## Item Drop

### ╨Т╤Л╨▒╤А╨╛╤Б╨╕╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В

```java
@Transactional
public void dropItem(UUID characterId, UUID itemId, int quantity) {
    // 1. ╨Э╨░╨╣╤В╨╕ ╨┐╤А╨╡╨┤╨╝╨╡╤В
    CharacterItem item = itemRepository.findById(itemId)
        .orElseThrow(() -> new ItemNotFoundException());
    
    if (!item.getCharacterId().equals(characterId)) {
        throw new UnauthorizedItemAccessException();
    }
    
    // 2. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М, ╨╝╨╛╨╢╨╜╨╛ ╨╗╨╕ ╨▓╤Л╨▒╤А╨╛╤Б╨╕╤В╤М
    if (!item.isDeletable()) {
        throw new CannotDropItemException("This item cannot be dropped");
    }
    
    // 3. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М ╨║╨╛╨╗╨╕╤З╨╡╤Б╤В╨▓╨╛
    if (quantity > item.getQuantity()) {
        throw new InsufficientQuantityException();
    }
    
    // 4. ╨Я╨╛╨╗╤Г╤З╨╕╤В╤М template ╨┤╨╗╤П ╨▓╨╡╤Б╨░
    ItemTemplate template = itemTemplateRepository.findById(item.getItemTemplateId()).get();
    double weight = template.getWeight() * quantity;
    
    // 5. ╨г╨╝╨╡╨╜╤М╤И╨╕╤В╤М ╨║╨╛╨╗╨╕╤З╨╡╤Б╤В╨▓╨╛ ╨╕╨╗╨╕ ╤Г╨┤╨░╨╗╨╕╤В╤М
    if (quantity == item.getQuantity()) {
        // ╨г╨┤╨░╨╗╨╕╤В╤М ╨┐╨╛╨╗╨╜╨╛╤Б╤В╤М╤О
        itemRepository.delete(item);
    } else {
        // ╨г╨╝╨╡╨╜╤М╤И╨╕╤В╤М ╨║╨╛╨╗╨╕╤З╨╡╤Б╤В╨▓╨╛
        item.setQuantity(item.getQuantity() - quantity);
        itemRepository.save(item);
    }
    
    // 6. ╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М ╨▓╨╡╤Б
    CharacterInventory inventory = inventoryRepository.findByCharacter(characterId).get();
    inventory.setCurrentWeight(inventory.getCurrentWeight() - weight);
    inventoryRepository.save(inventory);
    
    // 7. ╨б╨╛╨╖╨┤╨░╤В╤М world drop (╨▓ ╨╖╨╛╨╜╨╡)
    worldDropService.createDrop(
        getCharacterZone(characterId),
        getCharacterPosition(characterId),
        item.getItemTemplateId(),
        quantity
    );
    
    log.info("Character {} dropped {} x{}", characterId, item.getItemTemplateId(), quantity);
}
```

---

## Item Use/Consume

### ╨Ш╤Б╨┐╨╛╨╗╤М╨╖╨╛╨▓╨░╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В

```java
@Transactional
public UseItemResponse useItem(UUID characterId, UUID itemId) {
    // 1. ╨Э╨░╨╣╤В╨╕ ╨┐╤А╨╡╨┤╨╝╨╡╤В
    CharacterItem item = itemRepository.findById(itemId)
        .orElseThrow(() -> new ItemNotFoundException());
    
    // 2. ╨Я╨╛╨╗╤Г╤З╨╕╤В╤М template
    ItemTemplate template = itemTemplateRepository.findById(item.getItemTemplateId()).get();
    
    // 3. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М ╤В╨╕╨┐
    if (template.getItemType() != ItemType.CONSUMABLE) {
        throw new CannotUseItemException("This item is not consumable");
    }
    
    // 4. ╨Я╤А╨╕╨╝╨╡╨╜╨╕╤В╤М ╤Н╤Д╤Д╨╡╨║╤В╤Л
    List<ItemEffect> effects = template.getEffects();
    for (ItemEffect effect : effects) {
        applyEffect(characterId, effect);
    }
    
    // 5. ╨г╨╝╨╡╨╜╤М╤И╨╕╤В╤М quantity
    if (item.getQuantity() > 1) {
        item.setQuantity(item.getQuantity() - 1);
        itemRepository.save(item);
    } else {
        // ╨г╨┤╨░╨╗╨╕╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В
        itemRepository.delete(item);
    }
    
    // 6. ╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М ╨▓╨╡╤Б
    CharacterInventory inventory = inventoryRepository.findByCharacter(characterId).get();
    inventory.setCurrentWeight(inventory.getCurrentWeight() - template.getWeight());
    inventoryRepository.save(inventory);
    
    log.info("Character {} used item {}", characterId, template.getItemName());
    
    return new UseItemResponse("Item used successfully", effects);
}

private void applyEffect(UUID characterId, ItemEffect effect) {
    Character character = characterRepository.findById(characterId).get();
    
    switch (effect.getType()) {
        case HEAL:
            int newHealth = Math.min(
                character.getHealth() + effect.getValue(),
                character.getMaxHealth()
            );
            character.setHealth(newHealth);
            characterRepository.save(character);
            break;
            
        case BUFF:
            // ╨Я╤А╨╕╨╝╨╡╨╜╨╕╤В╤М ╨▓╤А╨╡╨╝╨╡╨╜╨╜╤Л╨╣ buff
            buffService.applyBuff(characterId, effect.getBuffId(), effect.getDuration());
            break;
            
        case RESTORE_STAMINA:
            // ...
            break;
            
        // ... other effects
    }
}
```

---

## Equipment System

### Equip Item

```java
@Transactional
public EquipResponse equipItem(UUID characterId, UUID itemId, String equipmentSlot) {
    // 1. ╨Э╨░╨╣╤В╨╕ ╨┐╤А╨╡╨┤╨╝╨╡╤В
    CharacterItem item = itemRepository.findById(itemId)
        .orElseThrow(() -> new ItemNotFoundException());
    
    if (item.getStorageType() == StorageType.EQUIPPED) {
        throw new ItemAlreadyEquippedException();
    }
    
    // 2. ╨Я╨╛╨╗╤Г╤З╨╕╤В╤М template
    ItemTemplate template = itemTemplateRepository.findById(item.getItemTemplateId()).get();
    
    // 3. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М, ╤З╤В╨╛ ╤Н╤В╨╛ equipment
    if (!isEquipmentType(template.getItemType())) {
        throw new CannotEquipItemException("This item cannot be equipped");
    }
    
    // 4. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М requirements
    if (!meetsRequirements(characterId, template)) {
        throw new RequirementsNotMetException();
    }
    
    // 5. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М ╤Б╨╗╨╛╤В
    EquipmentSlots slots = equipmentSlotsRepository.findByCharacter(characterId).get();
    
    UUID currentlyEquipped = getItemInSlot(slots, equipmentSlot);
    
    // 6. ╨Х╤Б╨╗╨╕ ╤Б╨╗╨╛╤В ╨╖╨░╨╜╤П╤В, unequip
    if (currentlyEquipped != null) {
        unequipItem(characterId, currentlyEquipped);
    }
    
    // 7. Equip ╨╜╨╛╨▓╤Л╨╣ ╨┐╤А╨╡╨┤╨╝╨╡╤В
    item.setStorageType(StorageType.EQUIPPED);
    item.setEquipmentSlot(equipmentSlot);
    item.setSlotIndex(null);
    
    // Bind-on-equip
    if (template.isBindOnEquip() && !item.isBound()) {
        item.setBindType(BindType.BIND_ON_EQUIP);
        item.setBound(true);
        item.setBoundAt(Instant.now());
    }
    
    itemRepository.save(item);
    
    // 8. ╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М equipment slots
    setItemInSlot(slots, equipmentSlot, itemId);
    equipmentSlotsRepository.save(slots);
    
    // 9. ╨Я╨╡╤А╨╡╤Б╤З╨╕╤В╨░╤В╤М stats ╨┐╨╡╤А╤Б╨╛╨╜╨░╨╢╨░
    recalculateCharacterStats(characterId);
    
    // 10. ╨г╨▓╨╡╨┤╨╛╨╝╨╕╤В╤М
    notificationService.send(
        getAccountId(characterId),
        new ItemEquippedNotification(template.getItemName())
    );
    
    log.info("Character {} equipped {} in slot {}", characterId, itemId, equipmentSlot);
    
    return new EquipResponse("Item equipped successfully");
}
```

### Unequip Item

```java
@Transactional
public void unequipItem(UUID characterId, UUID itemId) {
    // 1. ╨Э╨░╨╣╤В╨╕ ╨┐╤А╨╡╨┤╨╝╨╡╤В
    CharacterItem item = itemRepository.findById(itemId)
        .orElseThrow(() -> new ItemNotFoundException());
    
    // 2. ╨Э╨░╨╣╤В╨╕ ╤Б╨▓╨╛╨▒╨╛╨┤╨╜╤Л╨╣ ╤Б╨╗╨╛╤В ╨▓ backpack
    int freeSlot = findFreeSlot(characterId, StorageType.BACKPACK);
    if (freeSlot == -1) {
        throw new InventoryFullException("No free slots. Cannot unequip.");
    }
    
    // 3. ╨Я╨╡╤А╨╡╨╝╨╡╤Б╤В╨╕╤В╤М ╨▓ backpack
    String equipmentSlot = item.getEquipmentSlot();
    
    item.setStorageType(StorageType.BACKPACK);
    item.setEquipmentSlot(null);
    item.setSlotIndex(freeSlot);
    itemRepository.save(item);
    
    // 4. ╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М equipment slots
    EquipmentSlots slots = equipmentSlotsRepository.findByCharacter(characterId).get();
    setItemInSlot(slots, equipmentSlot, null);
    equipmentSlotsRepository.save(slots);
    
    // 5. ╨Я╨╡╤А╨╡╤Б╤З╨╕╤В╨░╤В╤М stats
    recalculateCharacterStats(characterId);
    
    log.info("Character {} unequipped {}", characterId, itemId);
}
```

---

## Bank/Stash Storage

### Deposit to Bank

```java
@Transactional
public void depositToBank(UUID characterId, UUID itemId, int quantity) {
    // 1. ╨Э╨░╨╣╤В╨╕ ╨┐╤А╨╡╨┤╨╝╨╡╤В ╨▓ backpack
    CharacterItem item = itemRepository.findById(itemId)
        .orElseThrow(() -> new ItemNotFoundException());
    
    if (item.getStorageType() != StorageType.BACKPACK) {
        throw new ItemNotInBackpackException();
    }
    
    // 2. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М, ╨╝╨╛╨╢╨╜╨╛ ╨╗╨╕ ╨┐╨╛╨╗╨╛╨╢╨╕╤В╤М ╨▓ ╨▒╨░╨╜╨║
    if (item.isBound()) {
        throw new CannotDepositBoundItemException();
    }
    
    // 3. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М bank slots
    UUID accountId = getAccountId(characterId);
    BankStorage bank = bankStorageRepository.findByAccount(accountId).get();
    
    int usedSlots = countBankUsedSlots(accountId);
    if (usedSlots >= bank.getMaxSlots()) {
        throw new BankFullException();
    }
    
    // 4. ╨Я╨╡╤А╨╡╨╝╨╡╤Б╤В╨╕╤В╤М ╨▓ bank
    if (quantity == item.getQuantity()) {
        // ╨Я╨╡╤А╨╡╨╝╨╡╤Б╤В╨╕╤В╤М ╨┐╨╛╨╗╨╜╨╛╤Б╤В╤М╤О
        int bankSlot = findFreeBankSlot(accountId);
        item.setStorageType(StorageType.BANK);
        item.setSlotIndex(bankSlot);
        itemRepository.save(item);
    } else {
        // Split stack
        item.setQuantity(item.getQuantity() - quantity);
        itemRepository.save(item);
        
        // ╨б╨╛╨╖╨┤╨░╤В╤М ╨╜╨╛╨▓╤Л╨╣ item ╨▓ ╨▒╨░╨╜╨║╨╡
        CharacterItem bankItem = item.clone();
        bankItem.setId(UUID.randomUUID());
        bankItem.setQuantity(quantity);
        bankItem.setStorageType(StorageType.BANK);
        bankItem.setSlotIndex(findFreeBankSlot(accountId));
        itemRepository.save(bankItem);
    }
    
    log.info("Character {} deposited {} x{} to bank", characterId, itemId, quantity);
}
```

### Withdraw from Bank

```java
@Transactional
public void withdrawFromBank(UUID characterId, UUID itemId, int quantity) {
    // Similar to deposit, but opposite direction
    // Check backpack space, move item from BANK to BACKPACK
    // ...
}
```

---

## Item Transfer (Trade/Mail/Auction)

### Transfer Item

```java
@Transactional
public void transferItem(
    UUID fromCharacterId,
    UUID toCharacterId,
    UUID itemId,
    int quantity,
    TransferType transferType
) {
    // 1. ╨Э╨░╨╣╤В╨╕ ╨┐╤А╨╡╨┤╨╝╨╡╤В
    CharacterItem item = itemRepository.findById(itemId)
        .orElseThrow(() -> new ItemNotFoundException());
    
    // 2. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М, ╨╝╨╛╨╢╨╜╨╛ ╨╗╨╕ ╨┐╨╡╤А╨╡╨┤╨░╤В╤М
    if (item.isBound()) {
        throw new CannotTradeB oundItemException();
    }
    
    if (!item.isTradeable()) {
        throw new ItemNotTradeableException();
    }
    
    // 3. ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М ╨┐╨╛╨╗╤Г╤З╨░╤В╨╡╨╗╤П
    if (!hasInventorySpace(toCharacterId, item.getItemTemplateId(), quantity)) {
        throw new RecipientInventoryFullException();
    }
    
    // 4. ╨г╨┤╨░╨╗╨╕╤В╤М ╤Г ╨╛╤В╨┐╤А╨░╨▓╨╕╤В╨╡╨╗╤П
    if (quantity == item.getQuantity()) {
        itemRepository.delete(item);
    } else {
        item.setQuantity(item.getQuantity() - quantity);
        itemRepository.save(item);
    }
    
    // 5. ╨б╨╛╨╖╨┤╨░╤В╤М ╤Г ╨┐╨╛╨╗╤Г╤З╨░╤В╨╡╨╗╤П
    CharacterItem newItem = new CharacterItem();
    newItem.setCharacterId(toCharacterId);
    newItem.setItemTemplateId(item.getItemTemplateId());
    newItem.setQuantity(quantity);
    newItem.setStorageType(StorageType.BACKPACK);
    newItem.setSlotIndex(findFreeSlot(toCharacterId, StorageType.BACKPACK));
    newItem.setAcquiredFrom(transferType.name()); // TRADE, MAIL, AUCTION
    itemRepository.save(newItem);
    
    // 6. ╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М ╨▓╨╡╤Б ╤Г ╨╛╨▒╨╛╨╕╤Е
    updateInventoryWeight(fromCharacterId);
    updateInventoryWeight(toCharacterId);
    
    log.info("Item {} x{} transferred from {} to {} via {}",
        itemId, quantity, fromCharacterId, toCharacterId, transferType);
}
```

---

## Item Durability

### Reduce Durability

```java
public void reduceDurability(UUID itemId, int amount) {
    CharacterItem item = itemRepository.findById(itemId).get();
    ItemTemplate template = itemTemplateRepository.findById(item.getItemTemplateId()).get();
    
    if (!template.hassDurability()) {
        return;
    }
    
    int newDurability = Math.max(0, item.getCurrentDurability() - amount);
    item.setCurrentDurability(newDurability);
    itemRepository.save(item);
    
    // ╨Х╤Б╨╗╨╕ durability = 0, item broken
    if (newDurability == 0) {
        handleItemBroken(item);
    } else if (newDurability < item.getMaxDurability() * 0.2) {
        // Low durability warning
        notificationService.send(
            getAccountId(item.getCharacterId()),
            new LowDurabilityWarning(template.getItemName())
        );
    }
}

private void handleItemBroken(CharacterItem item) {
    // Item broken, need repair
    item.setCurrentDurability(0);
    
    // ╨Х╤Б╨╗╨╕ equipped, ╤Б╨╜╤П╤В╤М stats bonuses
    if (item.getStorageType() == StorageType.EQUIPPED) {
        recalculateCharacterStats(item.getCharacterId());
    }
    
    notificationService.send(
        getAccountId(item.getCharacterId()),
        new ItemBrokenNotification(getItemName(item))
    );
}
```

### Repair Item

```java
@Transactional
public RepairResponse repairItem(UUID characterId, UUID itemId) {
    CharacterItem item = itemRepository.findById(itemId).get();
    
    // ╨Я╤А╨╛╨▓╨╡╤А╨╕╤В╤М ╤Б╤В╨╛╨╕╨╝╨╛╤Б╤В╤М ╤А╨╡╨╝╨╛╨╜╤В╨░
    int repairCost = calculateRepairCost(item);
    
    Character character = characterRepository.findById(characterId).get();
    if (character.getEddies() < repairCost) {
        throw new InsufficientFundsException();
    }
    
    // ╨б╨┐╨╕╤Б╨░╤В╤М ╨┤╨╡╨╜╤М╨│╨╕
    character.setEddies(character.getEddies() - repairCost);
    characterRepository.save(character);
    
    // ╨Т╨╛╤Б╤Б╤В╨░╨╜╨╛╨▓╨╕╤В╤М durability
    item.setCurrentDurability(item.getMaxDurability());
    itemRepository.save(item);
    
    // ╨Х╤Б╨╗╨╕ equipped, ╨┐╨╡╤А╨╡╤Б╤З╨╕╤В╨░╤В╤М stats
    if (item.getStorageType() == StorageType.EQUIPPED) {
        recalculateCharacterStats(characterId);
    }
    
    return new RepairResponse("Item repaired", repairCost);
}

private int calculateRepairCost(CharacterItem item) {
    ItemTemplate template = itemTemplateRepository.findById(item.getItemTemplateId()).get();
    
    double durabilityPercent = (double) item.getCurrentDurability() / item.getMaxDurability();
    double missingPercent = 1.0 - durabilityPercent;
    
    // ╨б╤В╨╛╨╕╨╝╨╛╤Б╤В╤М = vendor price * missing durability %
    return (int) (template.getVendorPrice() * missingPercent * 0.5); // 50% ╨╛╤В vendor price
}
```

---

## API Endpoints

### Inventory Management

**GET `/api/v1/inventory`** - ╨┐╨╛╨╗╤Г╤З╨╕╤В╤М ╨╕╨╜╨▓╨╡╨╜╤В╨░╤А╤М
```json
{
  "backpack": {
    "maxSlots": 50,
    "usedSlots": 25,
    "currentWeight": 120.5,
    "maxWeight": 200.0,
    "items": [
      {
        "id": "uuid",
        "templateId": "mantis_blades",
        "name": "Mantis Blades",
        "quantity": 1,
        "slotIndex": 0,
        "weight": 5.0,
        "rarity": "LEGENDARY"
      },
      ...
    ]
  },
  "equipment": {
    "weapon1": {...},
    "weapon2": {...},
    "armor": {...},
    ...
  }
}
```

**POST `/api/v1/inventory/pickup`** - ╨┐╨╛╨┤╨╛╨▒╤А╨░╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В
**POST `/api/v1/inventory/drop`** - ╨▓╤Л╨▒╤А╨╛╤Б╨╕╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В
**POST `/api/v1/inventory/use`** - ╨╕╤Б╨┐╨╛╨╗╤М╨╖╨╛╨▓╨░╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В

### Equipment

**POST `/api/v1/inventory/equip`** - ╨╜╨░╨┤╨╡╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В
**POST `/api/v1/inventory/unequip`** - ╤Б╨╜╤П╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В

### Bank/Stash

**GET `/api/v1/inventory/bank`** - ╨▒╨░╨╜╨║╨╛╨▓╤Б╨║╨╛╨╡ ╤Е╤А╨░╨╜╨╕╨╗╨╕╤Й╨╡
**POST `/api/v1/inventory/bank/deposit`** - ╨┐╨╛╨╗╨╛╨╢╨╕╤В╤М ╨▓ ╨▒╨░╨╜╨║
**POST `/api/v1/inventory/bank/withdraw`** - ╨╖╨░╨▒╤А╨░╤В╤М ╨╕╨╖ ╨▒╨░╨╜╨║╨░

### Item Management

**GET `/api/v1/inventory/items/{id}`** - ╨╕╨╜╤Д╨╛╤А╨╝╨░╤Ж╨╕╤П ╨╛ ╨┐╤А╨╡╨┤╨╝╨╡╤В╨╡
**POST `/api/v1/inventory/items/{id}/split`** - ╤А╨░╨╖╨┤╨╡╨╗╨╕╤В╤М ╤Б╤В╨╡╨║
**POST `/api/v1/inventory/items/{id}/move`** - ╨┐╨╡╤А╨╡╨╝╨╡╤Б╤В╨╕╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В (swap slots)
**POST `/api/v1/inventory/items/{id}/repair`** - ╨┐╨╛╤З╨╕╨╜╨╕╤В╤М ╨┐╤А╨╡╨┤╨╝╨╡╤В

---

## ╨Ш╨╜╤В╨╡╨│╤А╨░╤Ж╨╕╤П ╤Б ╨┤╤А╤Г╨│╨╕╨╝╨╕ ╤Б╨╕╤Б╤В╨╡╨╝╨░╨╝╨╕

### ╨Я╤А╨╕ ╨┐╨╛╨┤╨▒╨╛╤А╨╡ ╨┐╤А╨╡╨┤╨╝╨╡╤В╨░

```
InventoryService.pickupItem()
  тЖУ
тЖТ QuestService: check quest objectives (collect 10 items)
тЖТ AchievementService: check collection achievements
тЖТ NotificationService: send pickup notification
тЖТ EventBus: publish ITEM_PICKED_UP
```

### ╨Я╤А╨╕ equip

```
InventoryService.equipItem()
  тЖУ
тЖТ CharacterService: recalculate stats (with item bonuses)
тЖТ VisualService: update character appearance
тЖТ EventBus: publish ITEM_EQUIPPED
```

### ╨Я╤А╨╕ ╤А╨╡╨╝╨╛╨╜╤В╨╡

```
InventoryService.repairItem()
  тЖУ
тЖТ EconomyService: deduct repair cost
тЖТ CharacterService: recalculate stats (if equipped)
тЖТ EventBus: publish ITEM_REPAIRED
```

---

## ╨б╨▓╤П╨╖╨░╨╜╨╜╤Л╨╡ ╨┤╨╛╨║╤Г╨╝╨╡╨╜╤В╤Л

- `.BRAIN/05-technical/backend/player-character-management.md` - Character management
- `.BRAIN/05-technical/backend/loot-system.md` - Loot generation (╨▒╤Г╨┤╨╡╤В ╤Б╨╛╨╖╨┤╨░╨╜)
- `.BRAIN/02-gameplay/economy/equipment-matrix.md` - Equipment templates
- `.BRAIN/02-gameplay/economy/economy-crafting.md` - Crafting system

---

## TODO

- [ ] Item sorting (by name, rarity, type)
- [ ] Item search/filter
- [ ] Bulk operations (sell all junk, disenchant all)
- [ ] Auto-loot settings
- [ ] Item comparison (when hovering)

---

## ╨Ш╤Б╤В╨╛╤А╨╕╤П ╨╕╨╖╨╝╨╡╨╜╨╡╨╜╨╕╨╣

- **v1.0.0 (2025-11-07 05:20)** - ╨б╨╛╨╖╨┤╨░╨╜ ╨┤╨╛╨║╤Г╨╝╨╡╨╜╤В Inventory System

