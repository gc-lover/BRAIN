**Статус:** in_progress
**Приоритет:** medium
**Дата создания:** 2025-11-07
**Связанные документы:** `../../ideas/2025-11-07-IDEA-subliminal-easter-network.md`

# Сублиминальная сеть пасхалок — рабочий документ

## 1. Цели
- Детализировать механику скрытых сигналов (HUD, почта, билборды, подкасты, UI-пазлы, `/knock`).
- Подготовить требования к бэкенду (анти-спам, хранение логов, интеграция сервисов).
- Согласовать UX/UI: визуальные темы, компоненты, опциональный opt-in.
- Сформировать черновую матрицу API/событий для последующей генерации задач.

## 2. Контекст
- Идея фиксирует подпольную сеть «сигналов» в UI, не опирающуюся на прямые IP.
- Указанные микросервисы: `auth-service`, `social-service`, `world-service`, `audio-service`, `gameplay-service`, `inventory`, `realtime-server`.
- Требуется синхронизация с UI/UX, чтобы избежать конфликтов с основным HUD.

## 3. Требования к анти-спаму `/knock`
- **Rate limit (аккаунт):** не более 1 активации `/knock` в 10 минут; хранить счётчик в `social.knock_usage`.
- **Rate limit (сервер):** общее ограничение 120 активаций в 10 минут; мониторинг через `realtime.knock_throttle`.
- **Cooldown уведомлений:** повторное оповещение приходит не чаще раз в 15 минут на пользователя.
- **Санкции:** при нарушении лимитов `/knock` отправляет предупреждение; >5 нарушений за сутки добавляют флаг `knock_muted` на 24 часа (`auth-service`).
- **Требуемые API:**
  - POST `/social/knock` — инициировать событие (требует токен, проверка rate limit).
  - GET `/social/knock/log` — получить историю собственных активаций (ограничить 50 записей).
- **Логирование:** таблица `social.knock_events` (`id`, `actor_id`, `guild_id`, `timestamp`, `result`, `cooldown_remaining`).

## 4. Хранение логов кодов
- **Почтовые коды:**
  - Таблица `social.subliminal_codes`: `message_id`, `code_hash`, `issued_at`, `expires_at`, `claimed_by`, `claimed_at`, `status`.
  - Доступ через сервисную конечную точку `GET /social/subliminal-codes/{messageId}` (только для внутренних проверок).
- **Терминалы:** регистрируют использование кода (`world.terminal_logs`), включая координаты и shard.
- **Аудит:** ежедневный крон `social/maintenance` архивирует просроченные коды (`status = expired`).
- **Безопасность:** хранить только хеши кодов (SHA-256), в UI отображать маску `***-****`.

## 5. UX/UI требования
- **HUD «Подмигиватель»:** использовать `shared/ui/HUDIndicator` (добавить вариант `variant="afterglow"`); анимация ≤ 1.5 секунды, затем исчезает.
- **Afterglow UI:** тема в `shared/ui/theme`; переключение через `settings` модуль (раздел «Стили UI»).
- **Скрытый пункт меню:** компонент `SettingsAccordion`; условие отображения — флаг `ui_subliminal_opt_in`.
- **Глитч-билборды:** слой `world` + `shared/ui/AROverlay`; требуется мокап (UI команда) с балансом читаемости.
- **Опциональность:** добавить toggle «Подпольные сигналы» (по умолчанию `on`), предупреждение о возможных визуальных эффектах.
- **Музыкальные маркеры:** библиотека `audio-service` → ID `ui.resonance.marker1..n`; согласовать громкость/частоту.
- **UX задачи:**
  - Мокап HUD + уведомлений (UI дизайнеры).
  - Flow для терминала (дизайнер + UX писатель).
  - Подкаст плеер с подсветкой маркеров (audio + UI).

## 6. Технические зависимости
- **Auth:** хранение флагов `knock_muted`, `ui_subliminal_opt_in`.
- **Social:** почта, `/knock`, логирование кодов.
- **World:** билборды, терминалы, координаты подкастов.
- **Gameplay:** мини-игра «Calibrate Echo», выдача баффов.
- **Audio:** подкасты и маркеры.
- **Inventory:** косметика `Afterglow UI`, эмоция `Pixel Snap`, предмет `Encrypted Bookmark`.
- **Realtime:** обработка пинг-событий, push HUD уведомлений.

## 7. Метрики и мониторинг
- Количество активаций `/knock` (мин/час/сутки).
- % игроков с включённым `ui_subliminal_opt_in`.
- Среднее время прохождения аудио-квеста.
- Кол-во ложных срабатываний анти-спама.
- Успех/провал мини-игры (для балансировки).

## 8. Открытые вопросы
- Нужен ли единый глобальный чёрный список для нарушителей `/knock`?
- Требуется ли согласование с локализацией для скрытых сообщений?
- Нужно ли уведомление-компенсация игрокам, у которых `ui_subliminal_opt_in` выключено (чтобы не пропускали награды)?

## 9. Следующие шаги
1. Подготовить технические схемы (rate limit диаграммы, ERD для логов).
2. Созвон с UI/UX (слой HUD + меню) — предложить провести 2025-11-08.
3. Проверить совместимость с существующими уведомлениями (`world-service` событий).
4. После утверждения — передать черновик в Brain Readiness Checker.

